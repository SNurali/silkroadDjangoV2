# Документация Системы Silk Road

## 1. Обзор архитектуры
Система Silk Road построена на современном технологическом стеке для обеспечения высокой производительности и безопасности:
- **Backend**: Django (Python) + Django REST Framework.
- **Frontend**: React.js.
- **Основная БД**: PostgreSQL (хранение транзакций, бронирований и профилей).
- **Аналитическая БД**: ClickHouse (высокоскоростная обработка событий).
- **Кэш и Брокер**: Redis.
- **Очереди задач**: Celery (асинхронная обработка билетов, уведомлений и синхронизация).

## 2. Основные модули
### 2.1. Управление Пользователями (Accounts)
- Ролевая модель: Администраторы, Вендоры, Агенты, Операторы, Модераторы и обычные Пользователи.
- Безопасность: JWT-авторизация, логирование действий (`SecurityLog`).

### 2.2. Бронирование и Продажи (Bookings & Vendors)
- **Гостиницы**: Поиск с учетом доступности, управления типами номеров и ценами.
- **Достопримечательности (Sights)**: Продажа электронных билетов на туры и в музеи.
- **Вендоры**: Личный кабинет для управления объектами, подтверждения заказов и просмотра финансовой аналитики.

### 2.3. Слой Интеллекта и Аналитики (Analytics)
- Потоковая передача данных из PostgreSQL в ClickHouse через Django Signals.
- Автоматические оповещения о падении продаж или аномалиях.
- Скоринг вендоров на основе скорости подтверждения и отзывов.

## 3. Интеграция с системой e-mehmon
Интеграция с e-mehmon является критически важной для автоматизации регистрации иностранных граждан.

### 3.1. Поток синхронизации бронирований
1. При создании бронирования в системе Silk Road, запускается асинхронная задача `send_booking_to_emehmon_task`.
2. Система отправляет JSON-запрос в e-mehmon API с данными гостя.
3. Полученный идентификатор транзакции сохраняется в нашей БД.

### 3.2. Синхронизация статусов (Webhooks)
- Настроен Endpoint `/api/integrations/emehmon/webhook/` для приема обновлений от e-mehmon.
- При изменении статуса в e-mehmon, Silk Road мгновенно обновляет локальное бронирование и уведомляет клиента.

### 3.3. Регистрация иностранцев
- Система автоматически проверяет профили через `PERSON_INFO_FOREIGN_API`.
- Пользователи могут видеть свои данные о въезде и количестве оставшихся дней пребывания в личном кабинете.

## 4. Требования со стороны e-mehmon API
Для полноценного функционирования требуется:
1. **API Key/Secret**: Для авторизации запросов от нашего бэкэнда.
2. **Whitelist IP**: Добавление IP-адреса нашего сервера в список разрешенных.
3. **URL Webhook**: Регистрация нашего адреса для обратных вызовов.
4. **Схемы данных**: Соблюдение форматов JSON для регистрации (ФИО, паспортные данные, сроки).

## 5. Производительность и Безопасность
- **Кэширование**: Использование Redis для популярных направлений и курсов валют.
- **Throttling**: Ограничение частоты запросов для защиты от Brute-force атак.
- **Audit Log**: Полный след действий пользователей для соответствия требованиям безопасности.
